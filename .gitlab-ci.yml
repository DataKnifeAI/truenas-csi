# GitLab CI: Build CSI driver, Docker images, publish to Harbor
#
# Workflow: main → build → release | tags → build → publish to Harbor
#
# Required CI/CD variables (Settings → CI/CD → Variables):
#   HARBOR_REGISTRY - Harbor registry URL (e.g. harbor.example.com)
#   HARBOR_PROJECT  - Harbor project name (default: library)
#   HARBOR_USER     - Harbor username (masked)
#   HARBOR_PASSWORD - Harbor password/token (masked, protected)

stages:
  - build
  - docker
  - release

variables:
  IMAGE_NAME: truenas-csi
  IMAGE_NAME_UBI: truenas-csi-ubi
  HARBOR_PROJECT: library

.build_template: &build_template
  image: golang:1.24-alpine
  before_script:
    - cd $CI_PROJECT_DIR
    - go version

# Build on main (CI validation) and on tags (prior to publish)
build:
  stage: build
  <<: *build_template
  script:
    - go mod download
    - go build -v -o bin/truenas-csi cmd/main.go
    - go test ./... -v -short
  artifacts:
    paths:
      - bin/truenas-csi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

.docker_build_template: &docker_build_template
  stage: docker
  image:
    name: moby/buildkit:rootless
    entrypoint: [""]
  rules:
    - if: $CI_COMMIT_TAG
  tags:
    - kubernetes

publish-truenas-csi:
  <<: *docker_build_template
  needs: [build]
  script:
    - |
      if [ -z "$HARBOR_REGISTRY" ] || [ -z "$HARBOR_PROJECT" ]; then
        echo "❌ Error: HARBOR_REGISTRY or HARBOR_PROJECT not set"
        echo "HARBOR_REGISTRY: ${HARBOR_REGISTRY:-NOT SET}"
        echo "HARBOR_PROJECT: ${HARBOR_PROJECT:-NOT SET}"
        exit 1
      fi
      
      export DOCKER_CONFIG=$(mktemp -d)
      if [ -n "${HARBOR_USER:-}" ] && [ -n "${HARBOR_PASSWORD:-}" ]; then
        AUTH=$(printf '%s' "$HARBOR_USER:$HARBOR_PASSWORD" | base64 | tr -d '\n')
        echo '{"auths":{"'"$HARBOR_REGISTRY"'":{"auth":"'"$AUTH"'"}}}' > "$DOCKER_CONFIG/config.json"
      fi
      
      echo "Building truenas-csi image (Alpine)..."
      echo "Registry: $HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME"
      
      IMAGE_TAG="${CI_COMMIT_SHORT_SHA:-$CI_PIPELINE_ID}"
      OUTPUT_FLAGS="--output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:latest,push=true"
      OUTPUT_FLAGS="$OUTPUT_FLAGS --output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:$IMAGE_TAG,push=true"
      
      if [ -n "$CI_COMMIT_TAG" ]; then
        OUTPUT_FLAGS="$OUTPUT_FLAGS --output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME:$CI_COMMIT_TAG,push=true"
      fi
      
      buildctl-daemonless.sh build \
        --frontend dockerfile.v0 \
        --local context=. \
        --local dockerfile=. \
        $OUTPUT_FLAGS

publish-truenas-csi-ubi:
  <<: *docker_build_template
  needs: [build]
  script:
    - |
      if [ -z "$HARBOR_REGISTRY" ] || [ -z "$HARBOR_PROJECT" ]; then
        echo "❌ Error: HARBOR_REGISTRY or HARBOR_PROJECT not set"
        exit 1
      fi
      
      export DOCKER_CONFIG=$(mktemp -d)
      if [ -n "${HARBOR_USER:-}" ] && [ -n "${HARBOR_PASSWORD:-}" ]; then
        AUTH=$(printf '%s' "$HARBOR_USER:$HARBOR_PASSWORD" | base64 | tr -d '\n')
        echo '{"auths":{"'"$HARBOR_REGISTRY"'":{"auth":"'"$AUTH"'"}}}' > "$DOCKER_CONFIG/config.json"
      fi
      
      echo "Building truenas-csi-ubi image (OpenShift)..."
      echo "Registry: $HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME_UBI"
      
      IMAGE_TAG="${CI_COMMIT_SHORT_SHA:-$CI_PIPELINE_ID}"
      OUTPUT_FLAGS="--output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME_UBI:latest,push=true"
      OUTPUT_FLAGS="$OUTPUT_FLAGS --output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME_UBI:$IMAGE_TAG,push=true"
      
      if [ -n "$CI_COMMIT_TAG" ]; then
        OUTPUT_FLAGS="$OUTPUT_FLAGS --output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME_UBI:$CI_COMMIT_TAG,push=true"
      fi
      
      cp Dockerfile.ubi Dockerfile
      buildctl-daemonless.sh build \
        --frontend dockerfile.v0 \
        --local context=. \
        --local dockerfile=. \
        $OUTPUT_FLAGS
      rm -f Dockerfile

# Release on main (after build); publish to Harbor on tags only
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/cli:latest
  needs: [build]
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  script:
    - echo "Creating release for commit $CI_COMMIT_SHORT_SHA"
  release:
    tag_name: "v0.$CI_PIPELINE_IID"
    description: "Release v0.$CI_PIPELINE_IID"
    ref: "$CI_COMMIT_SHA"
  tags:
    - kubernetes
